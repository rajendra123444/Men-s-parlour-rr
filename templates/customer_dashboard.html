{% extends "base.html" %}

{% block title %}Customer Dashboard - Men's Parlour{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Top Header with Customer Name (Blue) -->
    <div class="customer-header text-center text-white">
        <h2>Welcome, {{ customer.name }}!</h2>
        <p class="mb-0">Customer #{{ customer.customer_number }}</p>
    </div>

    <div class="container-fluid px-4">
        <!-- Search your style box -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="input-group">
                    <input type="text" id="styleSearch" class="form-control form-control-lg" placeholder="Search your style...">
                    <button class="btn btn-primary btn-lg" type="button" onclick="searchStyles()">üîç Search</button>
                </div>
            </div>
        </div>

        <!-- Grid/Card toggle -->
        <div class="card-toggle mb-4">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary active" onclick="toggleView('grid')">Grid View</button>
                <button class="btn btn-outline-primary" onclick="toggleView('card')">Card View</button>
            </div>
        </div>

        <!-- Hairstyles Grid (default) -->
        <div class="styles-grid scrollable mb-4">
            {% for style in styles %}
            <div class="card h-100">
                <img src="{{ style.image_path }}" class="card-img-top" style="height: 150px; object-fit: cover;">
                <div class="card-body p-3">
                    <h6 class="card-title">{{ style.name }}</h6>
                    <small class="text-muted">{{ style.shop_name }}</small>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Profile Picture + Details Table (3x2) -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h4 class="text-center mb-3">üë§ Profile</h4>
                <div class="text-center mb-4">
                    <img src="{{ customer.profile_image or url_for('static', filename='images/default-profile.jpg') }}" 
                         alt="Profile" class="profile-pic" onerror="this.src='https://via.placeholder.com/80?text=üë§'">
                    <br><small class="text-muted">Click Edit to upload</small>
                </div>
            </div>
            <div class="col-md-6">
                <table class="table profile-table">
                    <tr><th>Name</th><td>{{ customer.name }}</td></tr>
                    <tr><th>Mobile</th><td>{{ customer.mobile }}</td></tr>
                    <tr><th>Email</th><td>{{ customer.email or 'Not set' }}</td></tr>
                </table>
                <form method="POST" action="{{ url_for('customer_update_profile') }}" enctype="multipart/form-data" class="text-center">
                    <input type="file" name="profile_image" accept="image/*" class="form-control mb-2 d-none" id="profileFile">
                    <input type="hidden" name="name" value="{{ customer.name }}">
                    <input type="hidden" name="mobile" value="{{ customer.mobile }}">
                    <input type="hidden" name="email" value="{{ customer.email or '' }}">
                    <button type="submit" class="btn btn-danger btn-lg-custom">Edit Details</button>
                </form>
            </div>
        </div>

        <!-- Appointment Section -->
        <div class="appointment-section">
            <h4 class="text-center mb-4">üìÖ Book Appointment</h4>
            <form method="POST" action="{{ url_for('book') }}" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Shop</label>
                    <select name="owner_id" class="form-select form-select-lg" required>
                        <option value="">Select Shop</option>
                        {% for owner in owners %}
                        <option value="{{ owner.id }}">{{ owner.shop_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Your Name</label>
                    <input type="text" name="name" class="form-control form-control-lg" value="{{ customer.name }}" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Mobile</label>
                    <input type="tel" name="mobile" class="form-control form-control-lg" value="{{ customer.mobile }}" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Time (09:00-21:00)</label>
                    <select name="time_slot" class="form-select form-select-lg" required>
                        {% for hour in range(9, 22) %}
                        <option>{{ "%02d:00"|format(hour) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-danger btn-lg w-100">üöÄ Book Appointment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Booking Status Popup -->
<div id="bookingPopup" class="booking-popup">
    <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Booking Status</h5>
            <button onclick="closePopup()" class="btn btn-sm btn-outline-secondary">‚úï</button>
        </div>
        <div id="popupContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Grid/Card toggle
function toggleView(view) {
    document.querySelector('.card-toggle').className = 'card-toggle ' + view;
    document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

// Style search (Google API when available)
function searchStyles() {
    const query = document.getElementById('styleSearch').value;
    if (!query) return;
    
    if ({{ google_available|tojson }}) {
        fetch(`/api/search_images?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                // Replace grid with Google results
                const grid = document.querySelector('.styles-grid');
                grid.innerHTML = data.items.map(item => 
                    `<div class="card h-100"><img src="${item.link}" class="card-img-top" style="height:150px;object-fit:cover;"><div class="card-body"><small>${item.title}</small></div></div>`
                ).join('');
            });
    } else {
        alert('Google search available when API key added');
    }
}

// Show latest booking popup
{% if last_booking %}
showBookingPopup({{ last_booking|tojson }});
{% endif %}

function showBookingPopup(booking) {
    const popup = document.getElementById('bookingPopup');
    const content = document.getElementById('popupContent');
    content.innerHTML = `
        <div class="text-center">
            <h6>${booking.shop_name}</h6>
            <p><strong>${booking.name}</strong></p>
            <p>${booking.time_slot} | ${booking.mobile}</p>
            <span class="badge bg-${booking.status === 'accepted' ? 'success' : booking.status === 'rejected' ? 'danger' : 'warning'} fs-6">
                ${booking.status.toUpperCase()}
            </span>
        </div>
    `;
    popup.style.display = 'block';
}

function closePopup() {
    document.getElementById('bookingPopup').style.display = 'none';
}
</script>
{% endblock %}